rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isAuthed() { return request.auth != null; }
    function isOrgMember(orgId) {
      return isAuthed() && exists(/databases/$(database)/documents/orgs/$(orgId)/members/$(request.auth.uid));
    }
    function roleOf(orgId) {
      return get(/databases/$(database)/documents/orgs/$(orgId)/members/$(request.auth.uid)).data.role;
    }
    function hasOrgRole(orgId, roles) {
      return isOrgMember(orgId) && roleOf(orgId) in roles;
    }
    match /orgs/{orgId}/weeks/{weekKey} {
      allow read: if isOrgMember(orgId);
      allow create, update: if hasOrgRole(orgId, ['admin','manager']);
      allow delete: if false;
    }
    match /orgs/{orgId}/alerts/{alertId} {
      allow read: if isOrgMember(orgId);
      allow create, update: if hasOrgRole(orgId, ['admin','manager']);
      allow delete: if false;
    }
    match /orgs/{orgId}/shiftTemplates/{tid} {
      allow read: if isOrgMember(orgId);
      allow create, update, delete: if hasOrgRole(orgId, ['admin','manager']);
    }
    match /orgs/{orgId}/shifts/{sid} {
      allow read: if isOrgMember(orgId);
      allow create, update, delete: if hasOrgRole(orgId, ['admin','manager']);
    }
    match /orgs/{orgId}/timesheets/{tsId} {
      allow read: if isOrgMember(orgId);
      allow create: if isOrgMember(orgId) && request.resource.data.uid == request.auth.uid;
      allow update: if hasOrgRole(orgId, ['admin','manager']) ||
                    (isOrgMember(orgId) && request.resource.data.uid == request.auth.uid && !resource.data.approved);
      allow delete: if false;
    }
    match /users/{uid} {
      allow read, update: if request.auth.uid == uid;
      allow create: if isAuthed();
      allow delete: if false;
    }
  }
}
